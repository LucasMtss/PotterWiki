import React, { useState, useEffect } from 'react';
import axios from 'axios';
import '../../src/personagens.css'
import brasao from '../images/brasão.png';



function Personagem() {

    const [dadosPersonagens, setDadosPersonagens] = useState(false)
    const [parametros, setParametros] = useState({ key: '$2a$10$TCvnyQmkvRjg/LHBQI5Snezq2FfP1QRNk.09sX4ZNEN98st34RWMi' })
    const [nomesPersonagens, setNomesPersonagens] = useState([])
    const [listaPersonagens, setListaPersonagens] = useState([])


    let getDadosPersonagens = async (parametros) => {

        let res
        // if (!dadosPersonagens) {
        console.log('requisição')
        res = await axios.get('https://www.potterapi.com/v1/characters', {
            params: parametros
        });
        // }

        setDadosPersonagens(res.data)

        // se a lista de nomes está vazia, ele pega os nomes da API, para não correr o risco de pegar os nomes duas vezes
        if (nomesPersonagens.length === 0)
            arrayDeNomes(res.data);

        // array com os dados dos personagens


        // for para pegar os dados de cada personagem e colocar no array
        var array = []
        for (var i = 0; i < dadosPersonagens.length; i++) {

            array.push(<ul className='cardPersonagem'><div className='cabecalhoCard' ><img src={brasao} /></div><li className='nome'><strong><u>Nome:</u> {dadosPersonagens[i].name}</strong></li><li><u>House: </u>{dadosPersonagens[i].house}</li><li><u>Blood status: </u>{dadosPersonagens[i].bloodStatus}</li><li><u>Boogart: </u>{dadosPersonagens[i].boogart}</li><li><u>Death eater: </u>{dadosPersonagens[i].deathEater}</li><li><u>Dumbledore's army: </u>{dadosPersonagens[i].dumbledoresArmy}</li><li><u>Ministry of magic: </u>{dadosPersonagens[i].ministryOfMagic}</li><li><u>Order of the Phoenix: </u>{dadosPersonagens[i].orderOfThePhoenix}</li><li><u>Patronus: </u>{dadosPersonagens[i].patronus}</li><li><u>Role: </u>{dadosPersonagens[i].role}</li><li><u>School: </u>{dadosPersonagens[i].school}</li><li><u>Species: </u>{dadosPersonagens[i].species}</li><li><u>Alias: </u>{dadosPersonagens[i].alias}</li><li><u>Wand: </u>{dadosPersonagens[i].wand}</li><li className='animagus'><u>Animagus: </u>{dadosPersonagens[i].animagus}</li><div className='footerCard'></div></ul >)
        }
        setListaPersonagens(array)
        console.log('personagens', array)
        if (!dadosPersonagens)
            setDadosPersonagens(res.data)

    }


    // cria um array com os nomes dos personagens para utilizar nas buscas
    function arrayDeNomes(dados) {
        let nomes = []
        for (var i = 0; i < dados.length; i++) {
            nomes.push(dados[i].name)
        }
        setNomesPersonagens(nomes)
    }

    useEffect(() => {
        console.log('passou no useEffect')

        if (dadosPersonagens === false)
            getDadosPersonagens(parametros)
        selecionaCasa()


    }, [])


    function selecionaCasa() {

        let casas = document.getElementsByName('casa')
        let casaSelecionada = 'all'
        for (let i = 0; i < casas.length; i++) {
            if (casas[i].checked)
                casaSelecionada = casas[i].value
        }
        if (casaSelecionada !== 'all')
            parametros.house = casaSelecionada
        else
            delete parametros.house
        console.log('casa: ', casaSelecionada)
        getDadosPersonagens(parametros)
    }

    // adiciona o nome digitado aos parâmetros na requisição da API
    var mudaNome = (event) => {
        let nome = event.target.value
        nome = nome.toLowerCase().replace(/(?:^|\s)\S/g, function (a) { return a.toUpperCase(); })
        // https://pt.stackoverflow.com/questions/32086/converter-cada-primeira-letra-de-cada-palavra-em-maiu%CC%81sculas#:~:text=Explica%C3%A7%C3%A3o%3A,%C3%A0%20primeira%20letra%20da%20string

        parametros.name = pessquisaParteDoNome(nome)
        pesquisaNome()
    }

    // Pesquisa o personagem com o nome escolhido
    function pesquisaNome() {
        getDadosPersonagens(parametros)
    }

    // Se o usuario digitar só uma paarte do nome, essa função procura pelo primeiro nome completo correspondente
    function pessquisaParteDoNome(nome) {
        for (let i = 0; i < nomesPersonagens.length; i++) {
            if (nomesPersonagens[i].indexOf(nome) >= 0)
                return nomesPersonagens[i]
        }
    }

    return (
        <div>
            <div className='pesquisa'>
                <input className='barraPesquisa' placeholder='Character name' onChange={mudaNome} />
                <button className='botaoPesquisar' onClick={pesquisaNome}>Pesquisar</button>
            </div>

            <div className='filtro'>
                <p>Filter by house</p>
                <input type='radio' name='casa' value='all' tagName='all' />
                <label>All</label> <br />
                <input type='radio' name='casa' value='Gryffindor' tagName='Grifinória' />
                <label>Gryffindor</label> <br />
                <input type='radio' name='casa' value='Ravenclaw' tagName='Corvinal' />
                <label>Ravenclaw</label> <br />
                <input type='radio' name='casa' value='Slytherin' tagName='Sonserina' />
                <label>Slytherin</label> <br />
                <input type='radio' name='casa' value='Hufflepuff' tagName='Lufa-lufa' />
                <label>Hufflepuff</label> <br />
                <button className='botaoFiltrar' onClick={selecionaCasa}>Filter</button>
            </div>

            <div className='divMaiorLista'>
                <div className='divMenorLista'>

                    {
                        listaPersonagens
                    }

                </div>
            </div>
        </div >
    )
}

export default Personagem